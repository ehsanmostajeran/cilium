--- worker.sh.orig	2015-10-26 18:33:54.185568818 +0000
+++ worker.sh	2015-10-26 18:33:44.002054682 +0000
@@ -19,6 +19,32 @@
 
 set -e
 
+dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
+
+# See if there's a different CILIUM_ROOT path set
+if [ -z ${CILIUM_ROOT} ]; then
+    CILIUM_ROOT=$( cd "$( dirname "${dir}/../../../../" )" && pwd )
+    echo "CILIUM_ROOT not set, using default: ${CILIUM_ROOT}"
+else
+    echo "CILIUM_ROOT is set to: ${CILIUM_ROOT}"
+fi
+
+# See if there's a different DOCKER_ENDPOINT set
+if [ -z ${DOCKER_ENDPOINT} ]; then
+    DOCKER_ENDPOINT="unix:///var/run/docker.sock"
+    echo "DOCKER_ENDPOINT not set, using default: ${DOCKER_ENDPOINT}"
+else
+    echo "Docker endpoint is set to: ${DOCKER_ENDPOINT}"
+fi
+
+# See if there's a different IP set
+if [ -z ${IP} ]; then
+    IP=$(hostname -i)
+    echo "IP not set, using default: ${IP}"
+else
+    echo "IP is set to: ${IP}"
+fi
+
 # Make sure docker daemon is running
 if ( ! ps -ef | grep "/usr/bin/docker" | grep -v 'grep' &> /dev/null  ); then
     echo "Docker is not running on this machine!"
@@ -62,7 +88,7 @@
         *64)
             ;;
         *)
-	        echo "Error: We currently only support 64-bit platforms."	    
+	        echo "Error: We currently only support 64-bit platforms."
 	        exit 1
 	        ;;
     esac
@@ -107,6 +133,12 @@
 
 # Start k8s components in containers
 start_k8s() {
+    if [ -f ${CILIUM_ROOT}/images/etcd.ditar ]; then
+        sudo docker -H unix:///var/run/docker-bootstrap.sock load -i ${CILIUM_ROOT}/images/etcd.ditar
+    fi
+    if [ -f ${CILIUM_ROOT}/images/flannel.ditar ]; then
+        sudo docker -H unix:///var/run/docker-bootstrap.sock load -i ${CILIUM_ROOT}/images/flannel.ditar
+    fi
     # Start flannel
     flannelCID=$(sudo docker -H unix:///var/run/docker-bootstrap.sock run -d --restart=always --net=host --privileged -v /dev/net:/dev/net quay.io/coreos/flannel:0.5.3 /opt/bin/flanneld --etcd-endpoints=http://${MASTER_IP}:4001 -iface="eth0")
 
@@ -147,7 +179,10 @@
 
     # sleep a little bit
     sleep 5
-    
+
+    # Start cilium
+    $dir/../../../entrypoint.sh infect
+
     # Start kubelet & proxy in container
     docker run \
         --net=host \
@@ -163,10 +198,11 @@
         gcr.io/google_containers/hyperkube:v${K8S_VERSION} \
         /hyperkube kubelet --api-servers=http://${MASTER_IP}:8080 \
         --v=2 --address=0.0.0.0 --enable-server \
-        --hostname-override=$(hostname -i) \
+        --hostname-override=${IP} \
         --cluster-dns=10.0.0.10 \
-        --cluster-domain=cluster.local
-    
+        --cluster-domain=cluster.local \
+	--docker-endpoint=${DOCKER_ENDPOINT}
+
     docker run \
         -d \
         --net=host \
